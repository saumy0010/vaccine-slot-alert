<!DOCTYPE html>
<html lang="en">

<head>
    <title>Covid data</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {


            // Disabling the submit button on start
            document.querySelector('#submit').disabled = true;
            document.querySelector('#btn').disabled = true;

            document.querySelector('#pincode').onkeyup = () => {

                if (document.querySelector('#pincode').value.length == 6) {
                    document.querySelector('#submit').disabled = false;
                } else {
                    document.querySelector('#submit').disabled = true;
                }
            }


            document.querySelector('form').onsubmit = function() {

                const pincode = document.querySelector('#pincode').value;
                let date = document.querySelector('#date').value;

                // changing format of date 
                date = date.split("-").reverse().join("-");



                // api url
                const api_url =
                    `https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/findByPin?pincode=${pincode}&date=${date}`;

                // Defining async function



                async function getapi(url) {

                    // Storing response
                    const response = await fetch(url);

                    // Storing data in form of JSON
                    var res_data = await response.json();

                    let flag = 0;


                    res_data.sessions.forEach(function(content) {
                        if (content.available_capacity > 0) {
                            flag = 1;
                        }
                    });

                    if (flag == 1) {
                        var audio = new Audio('alert.mp3');
                        audio.play();
                    }

                }



                // enabling the 'Set reminder' button on successfull submit
                document.querySelector('#btn').disabled = false;

                // Calling that async function
                let btn = document.getElementById('btn');
                btn.addEventListener('click', () => {
                    setInterval(function() {
                        getapi(api_url)
                    }, 5000);
                    document.querySelector('#btn').disabled = true;

                });





                fetch(`https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/findByPin?pincode=${pincode}&date=${date}`)
                    .then(response => response.json())
                    .then(data => {

                        var container = document.querySelector('#container');
                        var p = document.createElement('p');

                        if (data.centers == 0) {
                            alert('Vaccine is off')
                            document.querySelector('#start').innerHTML = 'Booking have not started yet.';
                        } else {
                            document.querySelector('#start').innerHTML = '';


                            // loop over the data

                            data.sessions.forEach(function(item) {
                                var slot = document.createElement('h3');
                                var name = document.createElement('span');
                                var dose1 = document.createElement('span');
                                var dose2 = document.createElement('span');
                                var vaccine = document.createElement('span');

                                slot.innerHTML = 'Available slots:' + item.available_capacity;
                                name.innerHTML = item.name + '. <br/> ';
                                vaccine.innerHTML = 'Vaccine:' + item.vaccine + '.<br/>';
                                dose1.innerHTML = 'Dose 1: ' + item.available_capacity_dose1 + '. <br/> ';;
                                dose2.innerHTML = 'Dose 2: ' + item.available_capacity_dose2;

                                p.appendChild(slot);
                                p.appendChild(name);
                                p.appendChild(vaccine);
                                p.appendChild(dose1);
                                p.appendChild(dose2);

                            });

                            info.appendChild(p);
                        }

                    }).catch(error => {
                        console.log('Error', error);
                    });


                return false;

            }
        });
    </script>
</head>

<body>
    <header class="header">
        <nav class="navbar navbar-style">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#micon">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>    
                    </button>
                    <a href="#">
                        <img class="logo" src="logo.jpg">
                    </a>
                </div>
                <div class="collapse navbar-collapse" id="micon">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#">Home</a>
                        </li>
                        <li>
                            <a href="#">About</a>
                        </li>
                        <li>
                            <a href="#">Contact</a>
                        </li>

                    </ul>
                </div>
            </div>

        </nav>
    </header>
    <div class="container anmi-shadow">
        <div class="col-sm-12 col-md-9">
            <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
            <lottie-player src="https://assets7.lottiefiles.com/packages/lf20_p2evb1ab.json" background="transparent" speed="1" style="width: 100%; height: 400px;" loop autoplay></lottie-player>

        </div>
        <div class="col-sm-12 col-md-3">
            <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
            <lottie-player src="https://assets7.lottiefiles.com/packages/lf20_ikyhq0rk.json" background="transparent" speed="1" style="width: 200px; height: 150px; padding-top: 50px;" loop autoplay></lottie-player>

            <a href="https://selfregistration.cowin.gov.in/" target="_blank">
                <button class="reg">Register</button>
            </a>
        </div>

    </div>
    <div class="container">
        <div class="input-box col-sm-12">
            <form>
                <input class="pincode" id="pincode" placeholder="Pincode" maxlength="6" minlength="6" type="number">
                <input id="date" placeholder="Date" type="date">
                <input id="submit" type="submit">
            </form>
        </div>
    </div>

    <div class="container">

        <div class="col-sm-6" id="info">
            <h2 id="start"></h2>
        </div>

        <div class="col-sm-6">
            <button id="btn" class="button" onclick="this.classList.toggle('button--loading')">
            <span class="button--text ">Set reminder</span>
            </button>
        </div>
        <div>
            <br>
            <br>
        </div>
    </div>
</body>

</html>